name: Patch Yi Home APK

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - '*.xapk'
      - '*.apk'
      - 'scripts/**'
      - '.github/workflows/patch-apk.yml'

permissions:
  contents: write

jobs:
  patch-apk:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Install apktool
        run: |
          wget https://raw.githubusercontent.com/iBotPeaches/Apktool/master/scripts/linux/apktool -O /usr/local/bin/apktool
          chmod +x /usr/local/bin/apktool
          wget https://bitbucket.org/iBotPeaches/apktool/downloads/apktool_2.10.0.jar -O /usr/local/bin/apktool.jar
          apktool --version

      - name: Download uber-apk-signer
        run: |
          wget https://github.com/patrickfav/uber-apk-signer/releases/download/v1.3.0/uber-apk-signer-1.3.0.jar -O uber-apk-signer.jar

      - name: Find and extract XAPK/APK
        id: find-apk
        run: |
          # Check for XAPK first, then APK
          if ls *.xapk 1> /dev/null 2>&1; then
            XAPK_FILE=$(ls *.xapk | head -1)
            echo "Found XAPK: $XAPK_FILE"
            echo "is_xapk=true" >> $GITHUB_OUTPUT

            # Extract XAPK (it's a ZIP file)
            mkdir -p extracted
            unzip -o "$XAPK_FILE" -d extracted

            echo "=== Extracted contents ==="
            ls -la extracted/

            # Find base APK
            if [ -f "extracted/base.apk" ]; then
              echo "apk_file=extracted/base.apk" >> $GITHUB_OUTPUT
            elif ls extracted/*.apk 1> /dev/null 2>&1; then
              BASE_APK=$(ls extracted/*.apk | head -1)
              echo "apk_file=$BASE_APK" >> $GITHUB_OUTPUT
            else
              echo "Error: No APK found in XAPK"
              exit 1
            fi
          elif ls *.apk 1> /dev/null 2>&1; then
            APK_FILE=$(ls *.apk | head -1)
            echo "Found APK: $APK_FILE"
            echo "is_xapk=false" >> $GITHUB_OUTPUT
            echo "apk_file=$APK_FILE" >> $GITHUB_OUTPUT
          else
            echo "Error: No XAPK or APK found"
            exit 1
          fi

      - name: Decompile APK
        run: |
          apktool d "${{ steps.find-apk.outputs.apk_file }}" -o decompiled -f

      - name: Extract version info
        id: version
        run: |
          # Debug: show the apktool.yml versionInfo section
          echo "=== apktool.yml versionInfo ==="
          grep -A5 'versionInfo:' decompiled/apktool.yml
          echo "==========================="

          # Extract version using awk - more reliable parsing
          VERSION_NAME=$(awk '/versionName:/ {gsub(/["\047]/, ""); print $2}' decompiled/apktool.yml | head -1)
          VERSION_CODE=$(awk '/versionCode:/ {gsub(/["\047]/, ""); print $2}' decompiled/apktool.yml | head -1)

          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "tag=v${VERSION_NAME}-noads" >> $GITHUB_OUTPUT

          echo "Extracted Version Name: [$VERSION_NAME]"
          echo "Extracted Version Code: [$VERSION_CODE]"
          echo "Tag: v${VERSION_NAME}-noads"

      - name: Apply ad removal patches
        run: |
          chmod +x scripts/patch-ads.sh
          ./scripts/patch-ads.sh decompiled

      - name: Rebuild APK
        run: |
          apktool b decompiled -o patched-base.apk

      - name: Sign all APKs
        run: |
          mkdir -p signed

          if [ "${{ steps.find-apk.outputs.is_xapk }}" == "true" ]; then
            # Copy patched base and all split APKs to signing directory
            cp patched-base.apk signed/base.apk

            # Copy split APKs (config.*, split_config.*, etc.)
            for split in extracted/split_*.apk extracted/config.*.apk; do
              if [ -f "$split" ]; then
                cp "$split" signed/
              fi
            done

            echo "=== APKs to sign ==="
            ls -la signed/

            # Sign all APKs with the same key
            java -jar uber-apk-signer.jar -a signed/ --allowResign --overwrite

            echo "=== Signed APKs ==="
            ls -la signed/
          else
            # Single APK mode
            cp patched-base.apk signed/
            java -jar uber-apk-signer.jar -a signed/patched-base.apk --allowResign
            mv signed/patched-base-aligned-debugSigned.apk signed/yi-home-${{ steps.version.outputs.version_name }}-noads.apk
          fi

      - name: Package signed XAPK
        if: steps.find-apk.outputs.is_xapk == 'true'
        run: |
          mkdir -p output

          # Create new XAPK structure
          mkdir -p xapk-content

          # Copy signed APKs
          cp signed/*.apk xapk-content/

          # Copy manifest and icon from original XAPK if they exist
          if [ -f "extracted/manifest.json" ]; then
            cp extracted/manifest.json xapk-content/
          fi
          if [ -f "extracted/icon.png" ]; then
            cp extracted/icon.png xapk-content/
          fi

          # Create the XAPK (ZIP with .xapk extension)
          cd xapk-content
          zip -r "../output/yi-home-${{ steps.version.outputs.version_name }}-noads.xapk" .
          cd ..

          # Also create a ZIP with individual APKs for adb install-multiple
          cd signed
          zip -r "../output/yi-home-${{ steps.version.outputs.version_name }}-noads-apks.zip" *.apk
          cd ..

          echo "=== Output files ==="
          ls -la output/

      - name: Prepare release files
        id: release-files
        run: |
          mkdir -p release

          if [ "${{ steps.find-apk.outputs.is_xapk }}" == "true" ]; then
            cp output/*.xapk release/
            cp output/*.zip release/
            echo "files=release/*" >> $GITHUB_OUTPUT
          else
            cp signed/yi-home-*.apk release/
            echo "files=release/*.apk" >> $GITHUB_OUTPUT
          fi

          ls -la release/

      - name: Check if release exists
        id: check_release
        run: |
          if gh release view "${{ steps.version.outputs.tag }}" > /dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release and Upload files
        if: steps.check_release.outputs.exists == 'false'
        run: |
          gh release create "${{ steps.version.outputs.tag }}" \
            --title "Yi Home ${{ steps.version.outputs.version_name }} (No Ads)" \
            --notes "## Yi Home App - Ad-Free Version

          **Version:** ${{ steps.version.outputs.version_name }}
          **Version Code:** ${{ steps.version.outputs.version_code }}

          ### Changes
          - Removed splash screen ads
          - Removed resume/background ads

          ### Installation

          #### Option 1: Using XAPK Installer
          1. Download the \`.xapk\` file
          2. Use an XAPK installer app (like APKPure or SAI)
          3. Install the package

          #### Option 2: Using ADB
          1. Download the \`.zip\` file containing individual APKs
          2. Extract the ZIP
          3. Run: \`adb install-multiple *.apk\`

          ---
          *Automatically patched by GitHub Actions*" \
            release/*
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update existing release
        if: steps.check_release.outputs.exists == 'true'
        run: |
          gh release upload "${{ steps.version.outputs.tag }}" \
            release/* \
            --clobber
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Output release URL
        run: |
          echo "Release created/updated at:"
          echo "https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }}"
