name: Patch Yi Home APK

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - '*.xapk'
      - '*.apk'
      - 'scripts/**'
      - '.github/workflows/patch-apk.yml'

permissions:
  contents: write

jobs:
  patch-apk:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Download APKEditor
        run: |
          wget https://github.com/REAndroid/APKEditor/releases/download/V1.4.7/APKEditor-1.4.7.jar -O APKEditor.jar
          java -jar APKEditor.jar -v

      - name: Download uber-apk-signer
        run: |
          wget https://github.com/patrickfav/uber-apk-signer/releases/download/v1.3.0/uber-apk-signer-1.3.0.jar -O uber-apk-signer.jar

      - name: Find input file
        id: find-input
        run: |
          if ls *.xapk 1> /dev/null 2>&1; then
            INPUT_FILE=$(ls *.xapk | head -1)
            echo "input_file=$INPUT_FILE" >> $GITHUB_OUTPUT
            echo "is_xapk=true" >> $GITHUB_OUTPUT
            echo "Found XAPK: $INPUT_FILE"
          elif ls *.apk 1> /dev/null 2>&1; then
            INPUT_FILE=$(ls *.apk | head -1)
            echo "input_file=$INPUT_FILE" >> $GITHUB_OUTPUT
            echo "is_xapk=false" >> $GITHUB_OUTPUT
            echo "Found APK: $INPUT_FILE"
          else
            echo "Error: No XAPK or APK found"
            exit 1
          fi

      - name: Merge XAPK to single APK
        if: steps.find-input.outputs.is_xapk == 'true'
        run: |
          java -jar APKEditor.jar m -i "${{ steps.find-input.outputs.input_file }}" -o merged.apk -f
          echo "Merged XAPK to single APK"

      - name: Copy APK for processing
        if: steps.find-input.outputs.is_xapk == 'false'
        run: |
          cp "${{ steps.find-input.outputs.input_file }}" merged.apk

      - name: Decode APK
        run: |
          java -jar APKEditor.jar d -i merged.apk -o decoded -f
          echo "=== Decoded structure ==="
          ls -la decoded/

      - name: Extract version info
        id: version
        run: |
          # Extract version from AndroidManifest.xml
          if [ -f "decoded/AndroidManifest.xml" ]; then
            VERSION_NAME=$(grep -oP 'android:versionName="[^"]*"' decoded/AndroidManifest.xml | head -1 | sed 's/android:versionName="//;s/"$//')
            VERSION_CODE=$(grep -oP 'android:versionCode="[^"]*"' decoded/AndroidManifest.xml | head -1 | sed 's/android:versionCode="//;s/"$//')
          fi

          # Fallback to archive-info.json if available
          if [ -z "$VERSION_NAME" ] && [ -f "decoded/archive-info.json" ]; then
            VERSION_NAME=$(cat decoded/archive-info.json | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('versionName',''))" 2>/dev/null || echo "")
            VERSION_CODE=$(cat decoded/archive-info.json | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('versionCode',''))" 2>/dev/null || echo "")
          fi

          # Default if still empty
          VERSION_NAME=${VERSION_NAME:-"unknown"}
          VERSION_CODE=${VERSION_CODE:-"0"}

          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "tag=v${VERSION_NAME}-noads" >> $GITHUB_OUTPUT

          echo "Version Name: $VERSION_NAME"
          echo "Version Code: $VERSION_CODE"
          echo "Tag: v${VERSION_NAME}-noads"

      - name: Apply patches
        run: |
          chmod +x scripts/patch-ads.sh
          ./scripts/patch-ads.sh decoded

      - name: Rebuild APK
        run: |
          java -jar APKEditor.jar b -i decoded -o patched.apk -f
          echo "=== Rebuilt APK ==="
          ls -la patched.apk

      - name: Sign APK
        run: |
          java -jar uber-apk-signer.jar -a patched.apk --allowResign
          ls -la patched*.apk
          mv patched-aligned-debugSigned.apk "yi-home-${{ steps.version.outputs.version_name }}-noads.apk"

      - name: Prepare release
        run: |
          mkdir -p release
          mv "yi-home-${{ steps.version.outputs.version_name }}-noads.apk" release/
          ls -la release/

      - name: Check if release exists
        id: check_release
        run: |
          if gh release view "${{ steps.version.outputs.tag }}" > /dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release
        if: steps.check_release.outputs.exists == 'false'
        run: |
          gh release create "${{ steps.version.outputs.tag }}" \
            --title "Yi Home ${{ steps.version.outputs.version_name }} (No Ads)" \
            --notes "## Yi Home App - Ad-Free Version

          **Version:** ${{ steps.version.outputs.version_name }}
          **Version Code:** ${{ steps.version.outputs.version_code }}

          ### Changes
          - Removed splash screen ads
          - Removed resume/background ads
          - Removed cloud plan popups and introductions
          - Removed AI purchase dialogs

          ### Installation
          1. Uninstall the original Yi Home app (if installed)
          2. Download the APK below
          3. Enable 'Install from unknown sources' if needed
          4. Install the APK

          ---
          *Automatically patched by GitHub Actions*" \
            release/*
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update existing release
        if: steps.check_release.outputs.exists == 'true'
        run: |
          gh release upload "${{ steps.version.outputs.tag }}" \
            release/* \
            --clobber
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Output release URL
        run: |
          echo "Release created/updated at:"
          echo "https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }}"
